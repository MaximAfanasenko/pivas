#!/bin/sh
# ------------------------------------------------------------------------------------------
#
# 	ПРОЕКТ КВАС
#
# ------------------------------------------------------------------------------------------
# 	Данный файл служит основной библиотекой функций пакета КВАС
# ------------------------------------------------------------------------------------------
#	Разработчик: kvas@zeleza.ru
#	Дата: 18/01/2024
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------------------

#	Подключаем библиотеку с функциями обработки ndm
. /opt/apps/kvas/bin/libs/ndm_d

cli_inface="$(inface_cli)"

if [ "${1}" = "hook" ] && echo "${id}" | grep -q "${cli_inface}"; then

	case "${layer}-${level}" in

#		Запускаем обработку при поднятии соединения
		"ctrl-running")
			cmd_vpn_iptable_reset &> /dev/null
#			link_up &> /dev/null
			logger -t "КВАС"  "Соединение ${id} успешно подключено."
		;;

#		Запускаем обработку при отключении соединении
		"ctrl-disabled" )
			link_reboot "${cli_inface}" &> /dev/null
			logger -t "КВАС"  "Соединение ${id} успешно завершено."
		;;

	esac

fi

if [ "${1}" = "hook" ] && is_ovpn_split_enabled && echo "${id}" | grep -q "$(inface_ovpn_cli)"; then
	case "${layer}-${level}" in
		"ctrl-running")
			{ ip4__flush 'chain table'; ip4_firewall_set_all_rules; } &> /dev/null
			logger -t "КВАС"  "OVPN split интерфейс ${id} подключен. Маршрутизация OVPN восстановлена."
		;;
		"ctrl-disabled" )
			{ ip4__flush 'chain table'; ip4_firewall_set_all_rules; } &> /dev/null
			logger -t "КВАС"  "OVPN split интерфейс ${id} отключен. Трафик возвращен в основной тоннель."
		;;
	esac
fi
